\
**Introduction**
================

[Traefik](https://traefik.io/traefik/) is a modern reverse proxy and load balancer that integrates with your existing 
service mesh infrastructure components and configures itself automatically and dynamically. 

The [official Traefik Docker repo](https://hub.docker.com/_/traefik) only supports Alpine 1.7 and Windows Server
Core 1809. This repo adds support for Windows Nano Server based on 
[Microsoft's PowerShell](https://hub.docker.com/_/microsoft-powershell) images and the release builds provided by
the [Traefik GitHub Project](https://github.com/traefik/traefik/releases/)

Sample [Docker Hub Images](https://hub.docker.com/r/seabopo/traefik) / Tags:
+ seabopo/traefik:nanoserver-1809
+ seabopo/traefik:nanoserver-1809-v2.8.0
+ seabopo/traefik:nanoserver-ltsc-2022
+ seabopo/traefik:nanoserver-ltsc-2022-v2.8.0


\
**Getting Started**
-------------------

The image application structure:

    /traefik
    /traefik/traefik.exe
    /traefik/conf
    /traefik/data
    /traefik/logs

The image entry point:

    ENTRYPOINT [ "/traefik/traefik.exe", "--configfile", "/traefik/conf/traefik.toml" ]

The image does not contain a configuration file. A configuration file must be mapped to 
(`/traefik/conf/traefik.toml`) via the docker run command.

\
A sample configuration file provided by the Traefik github repo.

```
[global]
  checkNewVersion = false
  sendAnonymousUsage = false

[entryPoints]
  [entryPoints.http]
  address = ":80"
  [entryPoints.traefik]
  address = ":8081"

[api]
  dashboard = true
  insecure  = true

[providers.consulCatalog]
  prefix           = "traefik"
  exposedByDefault = false

[providers.consulCatalog.endpoint]
  address = "127.0.0.1:8500"
  scheme  = "http"

[log]
  level = "DEBUG"
  filePath = "/traefik/logs/traefik.log"
  format = "common"
```

\
A Sample Docker command:

    docker run -d -p 80:80 -p 8081:8081 -v C:/local/:C:/traefik/conf/ --name traefik traefik:local

... where C:/local is a directory on the docker host that contains the `traefik.toml` configuration file.


\
A Sample Nomad job:
```
job "traefik" {

  region      = "local"
  datacenters = ["host"]
  type        = "service"

  group "traefik" {

    count = 1

    constraint {
        distinct_hosts = true
    }

    network {
      port "http" {
        static = 80
      }
      port "api" {
        static = 8081
      }
    }

    task "traefik" {

      driver = "docker"

      config {
        image = "seabopo/traefik:nanoserver-1809"
        volumes = [
          "local:C:/traefik/conf/"
        ]
        ports = ["http","api"]
      }

      template {
        data = <<EOF
        # Generated by NOMAD
        [global]
          checkNewVersion = false
          sendAnonymousUsage = false

        [entryPoints]
          [entryPoints.http]
          address = ":80"
          [entryPoints.traefik]
          address = ":8081"

        [api]
          dashboard = true
          insecure  = true

        [providers.consulCatalog]
          prefix           = "traefik"
          exposedByDefault = false

        [providers.consulCatalog.endpoint]
          address = "{{ env "attr.unique.network.ip-address" }}:8500"
          scheme  = "http"

        [log]
          level = "DEBUG"
          filePath = "/traefik/logs/traefik.log"
          format = "common"

        EOF
        destination = "local/traefik.toml"
      }

      resources {
        cpu    = 200
        memory = 512
      }

      service {
        name = "traefik"
        check {
            name     = "alive"
            type     = "tcp"
            port     = "http"
            interval = "10s"
            timeout  = "2s"
        }

      }
    }

  }
}
```
Note:
+ The job generates the config file in the template section and saves it to the job's allocation folder on the 
  docker host `destination = "local/traefik.toml"`.
+ The job maps the generated config file to the docker image in the volumes section.
+ The job maps the `[providers.consulCatalog.endpoint]` to query the consul instance of the local docker host, 
  which should match the IP address that is configured as the `client_addr` in the local Consul instance's service
  configuration file. Traefik will not communicate with the local Consul instance if the `client_addr` is set to
  127.0.0.1. The Consul `client_addr` needs to be configured to 0.0.0.0 (all IPs), the public IP of the PC or 
  the NAT IP of the local Docker network.
